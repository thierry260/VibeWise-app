import{t as g,a as d,b as we}from"../chunks/CnvfDVfY.js";import"../chunks/Bz5RaRe3.js";import{p as yt,f as ze,t as S,g as t,a as Rt,b as a,c as l,y as H,m as v,r as n,n as Ae,s as r}from"../chunks/BqLDX34w.js";import{e as f,r as Tt,s as U}from"../chunks/Dnxtqdj9.js";import{i as h}from"../chunks/CR_S-Ndk.js";import{e as Oe,i as Fe}from"../chunks/ByuM98jo.js";import{a as He,r as Q,s as kt}from"../chunks/CAWiHZCx.js";import{s as V}from"../chunks/CW1jeaI7.js";import{b as ge}from"../chunks/BIxOlcer.js";import{i as Pt}from"../chunks/DIvFRTmL.js";import{s as Et,a as St}from"../chunks/DSKrvmxr.js";import{o as Dt}from"../chunks/DWFD33l1.js";import{g as Ve}from"../chunks/Yt34wXNn.js";import{a as Mt}from"../chunks/DrO-CEjc.js";import{D as Ct,i as It,d as Be}from"../chunks/BAObU9c1.js";import{e as Lt,f as Ut,h as qt}from"../chunks/CGdVJ3Qh.js";var zt=g("<button> </button>"),At=g("<button> </button>"),Ot=g('<input type="datetime-local" class="svelte-1rwx4wf">'),Ft=g('<button class="record-button svelte-1rwx4wf">Start Recording</button>'),Ht=g('<div class="recording-indicator svelte-1rwx4wf"><span class="recording-pulse svelte-1rwx4wf"></span> </div> <button class="stop-button svelte-1rwx4wf">Stop Recording</button>',1),Vt=g('<button class="analyze-button svelte-1rwx4wf">Analyze Voice Tone</button>'),Bt=g('<div class="analyzing svelte-1rwx4wf">Analyzing voice tone...</div>'),Gt=g('<div class="voice-insight svelte-1rwx4wf"><span class="svelte-1rwx4wf">Detected tone: <strong class="svelte-1rwx4wf"> </strong></span> <span class="svelte-1rwx4wf"> </span></div>'),Nt=g('<div class="audio-player svelte-1rwx4wf"><audio controls class="svelte-1rwx4wf"></audio> <button class="delete-button svelte-1rwx4wf">Delete Recording</button> <!></div>'),Wt=g('<div class="error-message svelte-1rwx4wf"> </div>'),jt=g(`<div class="reflect-container svelte-1rwx4wf"><h1 class="svelte-1rwx4wf">New Reflection</h1> <div class="form-section svelte-1rwx4wf"><h2 class="svelte-1rwx4wf">How are you feeling?</h2> <div class="mood-selector svelte-1rwx4wf"><div class="mood-tabs svelte-1rwx4wf"><button>High Vibes</button> <button>Neutral</button> <button>Low Vibes</button></div> <div class="mood-options svelte-1rwx4wf"></div></div></div> <div class="form-section svelte-1rwx4wf"><h2 class="svelte-1rwx4wf">Describe your moment</h2> <textarea placeholder="What's happening in this moment? How do you feel?" rows="4" class="svelte-1rwx4wf"></textarea></div> <div class="form-section svelte-1rwx4wf"><h2 class="svelte-1rwx4wf">Tags</h2> <div class="tags-container svelte-1rwx4wf"></div> <div class="custom-tag svelte-1rwx4wf"><input type="text" placeholder="Add custom tag" class="svelte-1rwx4wf"> <button class="svelte-1rwx4wf">Add</button></div></div> <div class="form-section svelte-1rwx4wf"><h2 class="svelte-1rwx4wf">When did this happen?</h2> <div class="timestamp-selector svelte-1rwx4wf"><label class="svelte-1rwx4wf"><input type="radio" class="svelte-1rwx4wf"> Now</label> <label class="svelte-1rwx4wf"><input type="radio" class="svelte-1rwx4wf"> Choose time</label> <!></div></div> <div class="form-section svelte-1rwx4wf"><h2 class="svelte-1rwx4wf">Voice Log (Optional)</h2> <div class="voice-recorder svelte-1rwx4wf"><!></div></div> <!> <button class="submit-button svelte-1rwx4wf"><!></button></div> <!>`,1);function cr(Ge,Ne){yt(Ne,!1);const[We,je]=Et(),q=()=>St(Mt,"$authStore",We),X={high:["Joy","Appreciation","Empowerment","Freedom","Love","Passion","Enthusiasm","Eagerness","Happiness","Positive Expectation","Belief","Optimism","Hopefulness","Contentment"],neutral:["Boredom","Pessimism","Frustration","Irritation","Impatience","Overwhelm","Disappointment","Doubt","Worry"],low:["Blame","Discouragement","Anger","Revenge","Hatred","Rage","Jealousy","Insecurity","Guilt","Unworthiness","Fear","Grief","Depression","Despair","Powerlessness"]},Je=["Work","Family","Friends","Health","Relationship","Personal Growth","Finances","Creativity","Spirituality"];let p=v([]),D=v(""),m=v([]),R=v(""),B=v(new Date),M=v(!0),k=v(!1),b=null,z=[],_=v(null),x=v(null),G=v(0),y=null,C=null,w=v(null),N=v(!1),W=v(!1),A=v(!1),P=v(null),E=v("neutral");function $e(e){t(p).indexOf(e)===-1?r(p,[...t(p),e]):r(p,t(p).filter(s=>s!==e))}function Ke(e){t(m).indexOf(e)===-1?r(m,[...t(m),e]):r(m,t(m).filter(s=>s!==e))}function he(){t(R)&&!t(m).includes(t(R))&&(r(m,[...t(m),t(R)]),r(R,""))}function be(){r(M,!t(M)),t(M)&&r(B,new Date)}function Qe(){var e;try{return typeof window<"u"&&"Capacitor"in window&&typeof((e=window.Capacitor)==null?void 0:e.getPlatform)=="function"&&window.Capacitor.getPlatform()!=="web"}catch(o){return console.log("Error checking platform:",o),!1}}async function Xe(){var e;try{if(!Qe())return!0;console.log("Checking microphone permission on mobile");const o=window.Capacitor;return o.getPlatform()==="android"&&(e=o.Plugins)!=null&&e.Permissions?(await o.Plugins.Permissions.query({name:"microphone"})).state!=="granted"&&(console.log("Requesting microphone permission..."),(await o.Plugins.Permissions.request({name:"microphone"})).state!=="granted")?(alert("Microphone permission is required for voice recording"),!1):(console.log("Microphone permission granted"),!0):!0}catch(o){return console.error("Error requesting microphone permission:",o),alert("Unable to access microphone. Please enable microphone permissions in your device settings."),!1}}async function Ye(){try{if(!await Xe())throw new Error("Microphone permission denied");C=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});const o=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/ogg;codecs=opus"];let s={};for(const i of o)if(MediaRecorder.isTypeSupported(i)){s={mimeType:i},console.log(`Using supported MIME type: ${i}`);break}b=new MediaRecorder(C,s),z=[],b.addEventListener("dataavailable",i=>{i.data&&i.data.size>0&&z.push(i.data)}),b.addEventListener("stop",()=>{if(z.length>0){const i=(b==null?void 0:b.mimeType)||"audio/webm";r(_,new Blob(z,{type:i})),r(x,URL.createObjectURL(t(_))),console.log(`Recording completed: ${z.length} chunks, type: ${i}`)}else console.error("No audio data was recorded");r(k,!1),y&&(clearInterval(y),y=null),C&&C.getTracks().forEach(i=>i.stop())}),b.start(1e3),console.log("Recording started"),r(k,!0),r(G,0),y=setInterval(()=>{r(G,t(G)+1)},1e3)}catch(e){console.error("Error starting recording:",e),r(k,!1)}}function Ze(){if(b&&t(k))try{b.stop(),console.log("Recording stopped")}catch(e){console.error("Error stopping recording:",e),r(k,!1),y&&(clearInterval(y),y=null),C&&C.getTracks().forEach(o=>o.stop())}}function et(e){const o=Math.floor(e/60),s=e%60;return`${o}:${s.toString().padStart(2,"0")}`}async function _e(){if(t(_)){r(N,!0);try{const e=await qt(t(_));e.success&&e.tone&&e.confidence&&r(w,{tone:e.tone,confidence:e.confidence})}catch(e){console.error("Error analyzing voice:",e)}finally{r(N,!1)}}}async function tt(){if(q().user){if(t(p).length===0){r(P,"Please select at least one mood");return}if(!t(D).trim()){r(P,"Please enter a reflection");return}r(W,!0),r(P,null);try{let e="neutral";for(const c of t(p))if(X.high.includes(c)){e="high";break}else if(X.low.includes(c)){e="low";break}let o="",s="local";if(t(_)){const c=await Lt(q().user,t(_));c.success&&c.url&&(o=c.url,s=c.storage==="cloud"?"cloud":"local",t(w)||await _e())}const i={timestamp:t(B).toISOString(),mood:t(p),mood_level:e,text:t(D),tags:t(m),...o&&{audio_url:o,audio_storage:s},...t(w)&&{voice_insight:t(w)}};if((await Ut(q().user,i)).success)if(r(A,!0),await It(q().user)){const T=Be.showRandomTool();T&&await Be.logToolInteraction(q().user,T.id,"shown"),setTimeout(()=>{r(p,[]),r(D,""),r(m,[]),r(R,""),r(_,null),r(x,null),r(w,null),r(A,!1)},2e3)}else setTimeout(()=>{r(p,[]),r(D,""),r(m,[]),r(R,""),r(_,null),r(x,null),r(w,null),r(A,!1),Ve("/history")},2e3);else r(P,"Failed to save reflection. Please try again.")}catch(e){console.error("Error submitting reflection:",e),r(P,"An unexpected error occurred. Please try again.")}finally{r(W,!1)}}}Dt(()=>()=>{t(x)&&URL.revokeObjectURL(t(x)),y&&clearInterval(y)}),Pt();var xe=jt(),Y=ze(xe),Z=a(l(Y),2),ye=a(l(Z),2),ee=l(ye),te=l(ee);let Re;var re=a(te,2);let Te;var ke=a(re,2);let Pe;n(ee);var Ee=a(ee,2);Oe(Ee,5,()=>X[t(E)],Fe,(e,o)=>{var s=zt();let i;var u=l(s,!0);n(s),S(c=>{i=V(s,1,"mood-chip svelte-1rwx4wf",null,i,c),U(u,t(o))},[()=>({selected:t(p).includes(t(o))})],H),f("click",s,()=>$e(t(o))),d(e,s)}),n(Ee),n(ye),n(Z);var oe=a(Z,2),Se=a(l(oe),2);Tt(Se),n(oe);var se=a(oe,2),ae=a(l(se),2);Oe(ae,5,()=>Je,Fe,(e,o)=>{var s=At();let i;var u=l(s,!0);n(s),S(c=>{i=V(s,1,"tag-chip svelte-1rwx4wf",null,i,c),U(u,t(o))},[()=>({selected:t(m).includes(t(o))})],H),f("click",s,()=>Ke(t(o))),d(e,s)}),n(ae);var De=a(ae,2),j=l(De);Q(j);var rt=a(j,2);n(De),n(se);var ie=a(se,2),Me=a(l(ie),2),ne=l(Me),le=l(ne);Q(le),Ae(),n(ne);var ce=a(ne,2),ue=l(ce);Q(ue),Ae(),n(ce);var ot=a(ce,2);{var st=e=>{var o=Ot();Q(o),ge(o,()=>t(B),s=>r(B,s)),d(e,o)};h(ot,e=>{t(M)||e(st)})}n(Me),n(ie);var ve=a(ie,2),Ce=a(l(ve),2),at=l(Ce);{var it=e=>{var o=Ft();f("click",o,Ye),d(e,o)},nt=(e,o)=>{{var s=u=>{var c=Ht(),T=ze(c),O=a(l(T));n(T);var F=a(T,2);S($=>U(O,` Recording... ${$??""}`),[()=>et(t(G))],H),f("click",F,Ze),d(u,c)},i=(u,c)=>{{var T=O=>{var F=Nt(),$=l(F),Le=a($,2),ft=a(Le,2);{var mt=I=>{var K=Vt();f("click",K,_e),d(I,K)},pt=(I,K)=>{{var wt=L=>{var de=Bt();d(L,de)},gt=(L,de)=>{{var ht=fe=>{var me=Gt(),pe=l(me),Ue=a(l(pe)),bt=l(Ue,!0);n(Ue),n(pe);var qe=a(pe,2),_t=l(qe);n(qe),n(me),S(xt=>{U(bt,t(w).tone),U(_t,`Confidence: ${xt??""}%`)},[()=>Math.round(t(w).confidence*100)],H),d(fe,me)};h(L,fe=>{t(w)&&fe(ht)},de)}};h(I,L=>{t(N)?L(wt):L(gt,!1)},K)}};h(ft,I=>{!t(w)&&!t(N)?I(mt):I(pt,!1)})}n(F),S(()=>kt($,"src",t(x))),f("click",Le,()=>{r(x,null),r(_,null),r(w,null)}),d(O,F)};h(u,O=>{t(x)&&O(T)},c)}};h(e,u=>{t(k)?u(s):u(i,!1)},o)}};h(at,e=>{!t(k)&&!t(x)?e(it):e(nt,!1)})}n(Ce),n(ve);var Ie=a(ve,2);{var lt=e=>{var o=Wt(),s=l(o,!0);n(o),S(()=>U(s,t(P))),d(e,o)};h(Ie,e=>{t(P)&&e(lt)})}var J=a(Ie,2),ct=l(J);{var ut=e=>{var o=we("Saving...");d(e,o)},vt=(e,o)=>{{var s=u=>{var c=we("Saved!");d(u,c)},i=u=>{var c=we("Log Reflection");d(u,c)};h(e,u=>{t(A)?u(s):u(i,!1)},o)}};h(ct,e=>{t(W)?e(ut):e(vt,!1)})}n(J),n(Y);var dt=a(Y,2);Ct(dt,{onClose:()=>Ve("/history")}),S((e,o,s)=>{Re=V(te,1,"svelte-1rwx4wf",null,Re,e),Te=V(re,1,"svelte-1rwx4wf",null,Te,o),Pe=V(ke,1,"svelte-1rwx4wf",null,Pe,s),He(le,t(M)),He(ue,!t(M)),J.disabled=t(W)||t(A)},[()=>({active:t(E)==="high"}),()=>({active:t(E)==="neutral"}),()=>({active:t(E)==="low"})],H),f("click",te,()=>r(E,"high")),f("click",re,()=>r(E,"neutral")),f("click",ke,()=>r(E,"low")),ge(Se,()=>t(D),e=>r(D,e)),ge(j,()=>t(R),e=>r(R,e)),f("keydown",j,e=>e.key==="Enter"&&he()),f("click",rt,he),f("change",le,be),f("change",ue,be),f("click",J,tt),d(Ge,xe),Rt(),je()}export{cr as component};
