import{t as w,a as d,b as ge}from"../chunks/CN_4Jffs.js";import"../chunks/C_EceCEL.js";import{p as kt,ac as ze,t as S,g as t,b as yt,e as i,c as l,d as H,m as v,r as n,n as Ae,s as o}from"../chunks/C32UjKbq.js";import{e as f,r as Rt,s as U}from"../chunks/HXctbdJI.js";import{i as h}from"../chunks/CdUhBWiK.js";import{e as Oe,i as Fe}from"../chunks/BeeDwF9Y.js";import{a as He,r as Q,s as Tt}from"../chunks/B5wR7jRG.js";import{s as V}from"../chunks/COLsQU9v.js";import{b as we}from"../chunks/wrEaGex4.js";import{i as Pt}from"../chunks/BT-A8O5u.js";import{s as Et,a as St}from"../chunks/D2OzG1jj.js";import{o as Dt}from"../chunks/D1wvVs1Z.js";import{g as Ve}from"../chunks/C028ppxN.js";import{a as Mt}from"../chunks/DxcAzl92.js";import{D as Ct,i as It,d as Be}from"../chunks/BtggnnAo.js";import{e as Lt,f as Ut,h as qt}from"../chunks/L29Sq4FH.js";var zt=w("<button> </button>"),At=w("<button> </button>"),Ot=w('<input type="datetime-local" class="svelte-k8wt4x">'),Ft=w('<button class="record-button svelte-k8wt4x">Start Recording</button>'),Ht=w('<div class="recording-indicator svelte-k8wt4x"><span class="recording-pulse svelte-k8wt4x"></span> </div> <button class="stop-button svelte-k8wt4x">Stop Recording</button>',1),Vt=w('<button class="analyze-button svelte-k8wt4x">Analyze Voice Tone</button>'),Bt=w('<div class="analyzing svelte-k8wt4x">Analyzing voice tone...</div>'),Gt=w('<div class="voice-insight svelte-k8wt4x"><span class="svelte-k8wt4x">Detected tone: <strong class="svelte-k8wt4x"> </strong></span> <span class="svelte-k8wt4x"> </span></div>'),Nt=w('<div class="audio-player svelte-k8wt4x"><audio controls class="svelte-k8wt4x"></audio> <button class="delete-button svelte-k8wt4x">Delete Recording</button> <!></div>'),Wt=w('<div class="error-message svelte-k8wt4x"> </div>'),jt=w(`<div class="reflect-container svelte-k8wt4x"><h1 class="svelte-k8wt4x">New Reflection</h1> <div class="form-section svelte-k8wt4x"><h2 class="svelte-k8wt4x">How are you feeling?</h2> <div class="mood-selector svelte-k8wt4x"><div class="mood-tabs svelte-k8wt4x"><button>High Vibes</button> <button>Neutral</button> <button>Low Vibes</button></div> <div class="mood-options svelte-k8wt4x"></div></div></div> <div class="form-section svelte-k8wt4x"><h2 class="svelte-k8wt4x">Describe your moment</h2> <textarea placeholder="What's happening in this moment? How do you feel?" rows="4" class="svelte-k8wt4x"></textarea></div> <div class="form-section svelte-k8wt4x"><h2 class="svelte-k8wt4x">Tags</h2> <div class="tags-container svelte-k8wt4x"></div> <div class="custom-tag svelte-k8wt4x"><input type="text" placeholder="Add custom tag" class="svelte-k8wt4x"> <button class="svelte-k8wt4x">Add</button></div></div> <div class="form-section svelte-k8wt4x"><h2 class="svelte-k8wt4x">When did this happen?</h2> <div class="timestamp-selector svelte-k8wt4x"><label class="svelte-k8wt4x"><input type="radio" class="svelte-k8wt4x"> Now</label> <label class="svelte-k8wt4x"><input type="radio" class="svelte-k8wt4x"> Choose time</label> <!></div></div> <div class="form-section svelte-k8wt4x"><h2 class="svelte-k8wt4x">Voice Log (Optional)</h2> <div class="voice-recorder svelte-k8wt4x"><!></div></div> <!> <button class="submit-button svelte-k8wt4x"><!></button></div> <!>`,1);function co(Ge,Ne){kt(Ne,!1);const[We,je]=Et(),q=()=>St(Mt,"$authStore",We),X={high:["Joy","Appreciation","Empowerment","Freedom","Love","Passion","Enthusiasm","Eagerness","Happiness","Positive Expectation","Belief","Optimism","Hopefulness","Contentment"],neutral:["Boredom","Pessimism","Frustration","Irritation","Impatience","Overwhelm","Disappointment","Doubt","Worry"],low:["Blame","Discouragement","Anger","Revenge","Hatred","Rage","Jealousy","Insecurity","Guilt","Unworthiness","Fear","Grief","Depression","Despair","Powerlessness"]},Je=["Work","Family","Friends","Health","Relationship","Personal Growth","Finances","Creativity","Spirituality"];let p=v([]),D=v(""),m=v([]),y=v(""),B=v(new Date),M=v(!0),T=v(!1),b=null,z=[],_=v(null),x=v(null),G=v(0),k=null,C=null,g=v(null),N=v(!1),W=v(!1),A=v(!1),P=v(null),E=v("neutral");function $e(e){t(p).indexOf(e)===-1?o(p,[...t(p),e]):o(p,t(p).filter(a=>a!==e))}function Ke(e){t(m).indexOf(e)===-1?o(m,[...t(m),e]):o(m,t(m).filter(a=>a!==e))}function he(){t(y)&&!t(m).includes(t(y))&&(o(m,[...t(m),t(y)]),o(y,""))}function be(){o(M,!t(M)),t(M)&&o(B,new Date)}function Qe(){var e;try{return typeof window<"u"&&"Capacitor"in window&&typeof((e=window.Capacitor)==null?void 0:e.getPlatform)=="function"&&window.Capacitor.getPlatform()!=="web"}catch(s){return console.log("Error checking platform:",s),!1}}async function Xe(){var e;try{if(!Qe())return!0;console.log("Checking microphone permission on mobile");const s=window.Capacitor;return s.getPlatform()==="android"&&(e=s.Plugins)!=null&&e.Permissions?(await s.Plugins.Permissions.query({name:"microphone"})).state!=="granted"&&(console.log("Requesting microphone permission..."),(await s.Plugins.Permissions.request({name:"microphone"})).state!=="granted")?(alert("Microphone permission is required for voice recording"),!1):(console.log("Microphone permission granted"),!0):!0}catch(s){return console.error("Error requesting microphone permission:",s),alert("Unable to access microphone. Please enable microphone permissions in your device settings."),!1}}async function Ye(){try{if(!await Xe())throw new Error("Microphone permission denied");C=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});const s=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/ogg;codecs=opus"];let a={};for(const r of s)if(MediaRecorder.isTypeSupported(r)){a={mimeType:r},console.log(`Using supported MIME type: ${r}`);break}b=new MediaRecorder(C,a),z=[],b.addEventListener("dataavailable",r=>{r.data&&r.data.size>0&&z.push(r.data)}),b.addEventListener("stop",()=>{if(z.length>0){const r=(b==null?void 0:b.mimeType)||"audio/webm";o(_,new Blob(z,{type:r})),o(x,URL.createObjectURL(t(_))),console.log(`Recording completed: ${z.length} chunks, type: ${r}`)}else console.error("No audio data was recorded");o(T,!1),k&&(clearInterval(k),k=null),C&&C.getTracks().forEach(r=>r.stop())}),b.start(1e3),console.log("Recording started"),o(T,!0),o(G,0),k=setInterval(()=>{o(G,t(G)+1)},1e3)}catch(e){console.error("Error starting recording:",e),o(T,!1)}}function Ze(){if(b&&t(T))try{b.stop(),console.log("Recording stopped")}catch(e){console.error("Error stopping recording:",e),o(T,!1),k&&(clearInterval(k),k=null),C&&C.getTracks().forEach(s=>s.stop())}}function et(e){const s=Math.floor(e/60),a=e%60;return`${s}:${a.toString().padStart(2,"0")}`}async function _e(){if(t(_)){o(N,!0);try{const e=await qt(t(_));e.success&&e.tone&&e.confidence&&o(g,{tone:e.tone,confidence:e.confidence})}catch(e){console.error("Error analyzing voice:",e)}finally{o(N,!1)}}}async function tt(){if(q().user){if(t(p).length===0){o(P,"Please select at least one mood");return}if(!t(D).trim()){o(P,"Please enter a reflection");return}o(W,!0),o(P,null);try{let e="neutral";for(const c of t(p))if(X.high.includes(c)){e="high";break}else if(X.low.includes(c)){e="low";break}let s="",a="local";if(t(_)){const c=await Lt(q().user,t(_));c.success&&c.url&&(s=c.url,a=c.storage==="cloud"?"cloud":"local",t(g)||await _e())}const r={timestamp:t(B).toISOString(),mood:t(p),mood_level:e,text:t(D),tags:t(m),...s&&{audio_url:s,audio_storage:a},...t(g)&&{voice_insight:t(g)}};if((await Ut(q().user,r)).success)if(o(A,!0),await It(q().user)){const R=Be.showRandomTool();R&&await Be.logToolInteraction(q().user,R.id,"shown"),setTimeout(()=>{o(p,[]),o(D,""),o(m,[]),o(y,""),o(_,null),o(x,null),o(g,null),o(A,!1)},2e3)}else setTimeout(()=>{o(p,[]),o(D,""),o(m,[]),o(y,""),o(_,null),o(x,null),o(g,null),o(A,!1),Ve("/history")},2e3);else o(P,"Failed to save reflection. Please try again.")}catch(e){console.error("Error submitting reflection:",e),o(P,"An unexpected error occurred. Please try again.")}finally{o(W,!1)}}}Dt(()=>()=>{t(x)&&URL.revokeObjectURL(t(x)),k&&clearInterval(k)}),Pt();var xe=jt(),Y=ze(xe),Z=i(l(Y),2),ke=i(l(Z),2),ee=l(ke),te=l(ee);let ye;var oe=i(te,2);let Re;var Te=i(oe,2);let Pe;n(ee);var Ee=i(ee,2);Oe(Ee,5,()=>X[t(E)],Fe,(e,s)=>{var a=zt();let r;var u=l(a,!0);n(a),S(c=>{r=V(a,1,"mood-chip svelte-k8wt4x",null,r,c),U(u,t(s))},[()=>({selected:t(p).includes(t(s))})],H),f("click",a,()=>$e(t(s))),d(e,a)}),n(Ee),n(ke),n(Z);var se=i(Z,2),Se=i(l(se),2);Rt(Se),n(se);var ae=i(se,2),ie=i(l(ae),2);Oe(ie,5,()=>Je,Fe,(e,s)=>{var a=At();let r;var u=l(a,!0);n(a),S(c=>{r=V(a,1,"tag-chip svelte-k8wt4x",null,r,c),U(u,t(s))},[()=>({selected:t(m).includes(t(s))})],H),f("click",a,()=>Ke(t(s))),d(e,a)}),n(ie);var De=i(ie,2),j=l(De);Q(j);var ot=i(j,2);n(De),n(ae);var re=i(ae,2),Me=i(l(re),2),ne=l(Me),le=l(ne);Q(le),Ae(),n(ne);var ce=i(ne,2),ue=l(ce);Q(ue),Ae(),n(ce);var st=i(ce,2);{var at=e=>{var s=Ot();Q(s),we(s,()=>t(B),a=>o(B,a)),d(e,s)};h(st,e=>{t(M)||e(at)})}n(Me),n(re);var ve=i(re,2),Ce=i(l(ve),2),it=l(Ce);{var rt=e=>{var s=Ft();f("click",s,Ye),d(e,s)},nt=(e,s)=>{{var a=u=>{var c=Ht(),R=ze(c),O=i(l(R));n(R);var F=i(R,2);S($=>U(O,` Recording... ${$??""}`),[()=>et(t(G))],H),f("click",F,Ze),d(u,c)},r=(u,c)=>{{var R=O=>{var F=Nt(),$=l(F),Le=i($,2),ft=i(Le,2);{var mt=I=>{var K=Vt();f("click",K,_e),d(I,K)},pt=(I,K)=>{{var gt=L=>{var de=Bt();d(L,de)},wt=(L,de)=>{{var ht=fe=>{var me=Gt(),pe=l(me),Ue=i(l(pe)),bt=l(Ue,!0);n(Ue),n(pe);var qe=i(pe,2),_t=l(qe);n(qe),n(me),S(xt=>{U(bt,t(g).tone),U(_t,`Confidence: ${xt??""}%`)},[()=>Math.round(t(g).confidence*100)],H),d(fe,me)};h(L,fe=>{t(g)&&fe(ht)},de)}};h(I,L=>{t(N)?L(gt):L(wt,!1)},K)}};h(ft,I=>{!t(g)&&!t(N)?I(mt):I(pt,!1)})}n(F),S(()=>Tt($,"src",t(x))),f("click",Le,()=>{o(x,null),o(_,null),o(g,null)}),d(O,F)};h(u,O=>{t(x)&&O(R)},c)}};h(e,u=>{t(T)?u(a):u(r,!1)},s)}};h(it,e=>{!t(T)&&!t(x)?e(rt):e(nt,!1)})}n(Ce),n(ve);var Ie=i(ve,2);{var lt=e=>{var s=Wt(),a=l(s,!0);n(s),S(()=>U(a,t(P))),d(e,s)};h(Ie,e=>{t(P)&&e(lt)})}var J=i(Ie,2),ct=l(J);{var ut=e=>{var s=ge("Saving...");d(e,s)},vt=(e,s)=>{{var a=u=>{var c=ge("Saved!");d(u,c)},r=u=>{var c=ge("Log Reflection");d(u,c)};h(e,u=>{t(A)?u(a):u(r,!1)},s)}};h(ct,e=>{t(W)?e(ut):e(vt,!1)})}n(J),n(Y);var dt=i(Y,2);Ct(dt,{onClose:()=>Ve("/history")}),S((e,s,a)=>{ye=V(te,1,"svelte-k8wt4x",null,ye,e),Re=V(oe,1,"svelte-k8wt4x",null,Re,s),Pe=V(Te,1,"svelte-k8wt4x",null,Pe,a),He(le,t(M)),He(ue,!t(M)),J.disabled=t(W)||t(A)},[()=>({active:t(E)==="high"}),()=>({active:t(E)==="neutral"}),()=>({active:t(E)==="low"})],H),f("click",te,()=>o(E,"high")),f("click",oe,()=>o(E,"neutral")),f("click",Te,()=>o(E,"low")),we(Se,()=>t(D),e=>o(D,e)),we(j,()=>t(y),e=>o(y,e)),f("keydown",j,e=>e.key==="Enter"&&he()),f("click",ot,he),f("change",le,be),f("change",ue,be),f("click",J,tt),d(Ge,xe),yt(),je()}export{co as component};
