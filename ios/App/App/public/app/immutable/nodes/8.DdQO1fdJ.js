const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["../chunks/D7Jg-ab8.js","../chunks/B1jByD-r.js","../chunks/Dp1pzeXC.js"])))=>i.map(i=>d[i]);
import{t as k,a as B,b as Ee}from"../chunks/B1TZXfti.js";import"../chunks/VBNCskEB.js";import{h as We,p as jt,ao as yt,ap as Dt,ac as Et,b as Rt,e as o,c as t,g as s,m as C,r as a,s as f,n as Re,t as de,d as Je}from"../chunks/CDb6m0PD.js";import{e as ve,s as b}from"../chunks/CxWVBdvW.js";import{i as M}from"../chunks/Dm4goCkW.js";import{t as Tt,s as se}from"../chunks/BqtZpFwS.js";import{t as Te,a as xe}from"../chunks/DptaK6WB.js";import{b as xt}from"../chunks/C1IXUDxN.js";import{i as Ct}from"../chunks/CGS7UL4d.js";import{s as Bt,a as ue}from"../chunks/CbuS4uut.js";import{g as he,w as Pe,o as It,a as Ht}from"../chunks/BOa5fj8P.js";import{g as Ce}from"../chunks/DXN4q5X4.js";import{a as Pt}from"../chunks/3OU4Vcau.js";import{D as At,i as Vt,d as Ke}from"../chunks/Cefqs-SS.js";import{i as Mt}from"../chunks/BERqu7mZ.js";import{_ as Ae}from"../chunks/Dp1pzeXC.js";import{u as kt}from"../chunks/BXsTdfT2.js";function Ut(n,e,r,m){var l=n.__style;if(We||l!==e){var u=Tt(e);(!We||u!==n.getAttribute("style"))&&(u==null?n.removeAttribute("style"):n.style.cssText=u),n.__style=e}return m}const pe=()=>typeof window.Capacitor<"u";console.log("Environment check:",{isCapacitor:pe(),hasWebBluetooth:typeof navigator<"u"&&"bluetooth"in navigator});const I=Pe({connected:!1,deviceName:"",deviceId:"",error:null,scanning:!1}),ge=Pe({heartRate:0,rmssd:0,vibeScore:0,rrIntervals:[],chartData:[]}),N=Pe({startTime:0,currentTime:0,elapsedSeconds:0,isRunning:!1}),Ie=()=>pe()?!0:typeof navigator<"u"&&"bluetooth"in navigator,Lt=async()=>{var n;try{if(!Ie())throw new Error("Bluetooth is not supported on this device");if(I.update(e=>({...e,scanning:!0,error:null})),console.log("Starting BLE scan..."),pe()){console.log("Using Capacitor BLE implementation");try{const{BleClient:e}=await Ae(async()=>{const{BleClient:l}=await import("../chunks/D7Jg-ab8.js");return{BleClient:l}},__vite__mapDeps([0,1,2]),import.meta.url);console.log("Initializing BLE client..."),await e.initialize();const r=await e.isEnabled();if(console.log("Bluetooth enabled:",r),!r)try{await e.enable(),console.log("Bluetooth enabled successfully")}catch(l){throw console.error("Failed to enable Bluetooth:",l),new Error("Please enable Bluetooth to connect to your device")}console.log("Requesting device...");const m=await e.requestDevice({services:["0000180d-0000-1000-8000-00805f9b34fb"],namePrefix:"Polar"});return console.log("Device selected:",m),await $t(m.deviceId,m.name||"Polar Device"),{success:!0}}catch(e){throw console.error("Capacitor BLE error:",e),e}}else{if(console.log("Using Web Bluetooth API implementation"),!("bluetooth"in navigator))throw new Error("Web Bluetooth is not supported in this browser");console.log("Requesting device...");const e=await navigator.bluetooth.requestDevice({filters:[{services:["heart_rate"]},{namePrefix:"Polar"}],optionalServices:["heart_rate"]});console.log("Device selected:",e.name),I.update(u=>({...u,deviceName:e.name||"Unknown Device",deviceId:e.id})),console.log("Connecting to GATT server...");const r=await((n=e.gatt)==null?void 0:n.connect());if(!r)throw new Error("Failed to connect to GATT server");console.log("Getting Heart Rate service...");const m=await r.getPrimaryService("heart_rate");console.log("Getting Heart Rate Measurement characteristic...");const l=await m.getCharacteristic("heart_rate_measurement");return console.log("Starting notifications..."),await l.startNotifications(),console.log("Adding event listener for heart rate measurements..."),l.addEventListener("characteristicvaluechanged",Gt),I.update(u=>({...u,connected:!0,scanning:!1})),e.addEventListener("gattserverdisconnected",()=>{console.log("Device disconnected"),I.update(_=>({..._,connected:!1,error:new Error("Device disconnected")})),he(N).isRunning&&Ve()}),{success:!0}}}catch(e){return console.error("BLE scan error:",e),I.update(r=>({...r,scanning:!1,error:e instanceof Error?e:new Error("Unknown BLE error")})),{success:!1,error:e instanceof Error?e:new Error("Unknown BLE error")}}};async function $t(n,e){try{console.log("Connecting to Capacitor device:",n,e);const{BleClient:r}=await Ae(async()=>{const{BleClient:u}=await import("../chunks/D7Jg-ab8.js");return{BleClient:u}},__vite__mapDeps([0,1,2]),import.meta.url);console.log("Establishing connection..."),await r.connect(n),console.log("Connected successfully"),I.update(u=>({...u,deviceName:e,deviceId:n,connected:!0,scanning:!1}));const m="0000180d-0000-1000-8000-00805f9b34fb",l="00002a37-0000-1000-8000-00805f9b34fb";console.log("Starting notifications for heart rate..."),await r.startNotifications(n,m,l,u=>{const _=new DataView(u.buffer);Ft(_)}),console.log("Notifications started successfully"),Xe()}catch(r){console.error("Error connecting to Capacitor device:",r),I.update(m=>({...m,connected:!1,scanning:!1,error:r instanceof Error?r:new Error("Failed to connect to device")}))}}function Ft(n){const e=n.getUint8(0),r=e&1,m=r?n.getUint16(1,!0):n.getUint8(1),l=[];if(e&16){const u=r?3:2;for(let _=u;_<n.byteLength;_+=2){const y=n.getUint16(_,!0)/1024*1e3;l.push(y)}}Qe(m,l)}const Gt=n=>{const e=n.target.value;if(!e)return;const r=e.getUint8(0),m=r&1,l=m?e.getUint16(1,!0):e.getUint8(1),u=[];if(r&16){const _=m?3:2;for(let y=_;y<e.byteLength;y+=2){const D=e.getUint16(y,!0)/1024*1e3;u.push(D)}}Qe(l,u)},Qe=(n,e)=>{ge.update(r=>{const l=[...r.rrIntervals,...e].slice(-64);let u=0;if(l.length>1){let U=0;for(let R=1;R<l.length;R++){const L=l[R]-l[R-1];U+=L*L}u=Math.sqrt(U/(l.length-1))}const _=Math.min(100,Math.max(0,u/100*100)),y=Math.round(_),D=new Date().toISOString(),P=[...r.chartData,{timestamp:D,hr:n,rmssd:u,vibe:y}].slice(-300);return{heartRate:n,rmssd:u,vibeScore:y,rrIntervals:l,chartData:P}})},Be=async()=>{try{const n=he(I).deviceId;if(n&&pe())try{const{BleClient:e}=await Ae(async()=>{const{BleClient:r}=await import("../chunks/D7Jg-ab8.js");return{BleClient:r}},__vite__mapDeps([0,1,2]),import.meta.url);await e.disconnect(n)}catch(e){console.error("Error disconnecting from Capacitor device:",e)}return I.set({connected:!1,deviceName:"",deviceId:"",error:null,scanning:!1}),He(),Ve(),{success:!0}}catch(n){return console.error("BLE disconnect error:",n),{success:!1,error:n instanceof Error?n:new Error("Unknown BLE error")}}},He=()=>{ge.set({heartRate:0,rmssd:0,vibeScore:0,rrIntervals:[],chartData:[]})},Xe=()=>{const n=Date.now();N.set({startTime:n,currentTime:n,elapsedSeconds:0,isRunning:!0});const e=setInterval(()=>{N.update(r=>{if(!r.isRunning)return clearInterval(e),r;const m=Date.now(),l=Math.floor((m-r.startTime)/1e3);return{...r,currentTime:m,elapsedSeconds:l}})},1e3)},Ve=()=>{N.update(n=>({...n,isRunning:!1}))},Ot=()=>{const n=he(ge),e=he(N),r=n.chartData;let m=0,l=0,u=0;r.forEach(p=>{m+=p.hr,l+=p.rmssd,u+=p.vibe});const _=r.length?Math.round(m/r.length):0,y=r.length?Math.round(l/r.length*10)/10:0,D=r.length?Math.round(u/r.length):0;return{startTime:new Date(e.startTime).toISOString(),endTime:new Date(e.currentTime).toISOString(),durationSeconds:e.elapsedSeconds,avgHR:_,avgRMSSD:y,avgVibe:D,chartData:r,rrIntervals:n.rrIntervals}};var zt=k('<div class="error-message svelte-js47dh"> </div>'),Nt=k('<div class="compatibility-warning svelte-js47dh"><p class="svelte-js47dh">Bluetooth is not supported on this device.</p> <p class="svelte-js47dh">Please use a device with Bluetooth support or the mobile app.</p></div>'),qt=k(`<div class="start-session svelte-js47dh"><p class="instructions svelte-js47dh">Connect your Polar H10 heart rate monitor to begin tracking your heart rate variability
				(HRV). This will help calculate your Vibe Score and track your physiological balance.</p> <!> <button class="start-button svelte-js47dh">Connect to Polar H10</button> <!></div>`),Wt=k('<div class="session-active svelte-js47dh"><div class="status-bar svelte-js47dh"><div class="connection-status svelte-js47dh"><span></span> <span class="svelte-js47dh"> </span></div> <div class="session-timer svelte-js47dh"> </div></div> <div class="session-container svelte-js47dh"><div class="metrics-container svelte-js47dh"><div class="metric svelte-js47dh"><h3 class="svelte-js47dh">Heart Rate</h3> <p class="value svelte-js47dh"> <span class="unit svelte-js47dh">BPM</span></p></div> <div class="metric svelte-js47dh"><h3 class="svelte-js47dh">Balance</h3> <p class="value svelte-js47dh"> <span class="unit svelte-js47dh">ms</span></p></div> <div class="metric svelte-js47dh"><h3 class="svelte-js47dh">Vibe Score</h3> <p class="value svelte-js47dh"> </p></div></div> <div class="timer-container svelte-js47dh"><p class="timer svelte-js47dh"> </p></div> <div class="chart-section svelte-js47dh"><h3 class="mb-2 text-xl font-semibold svelte-js47dh">Real-time HRV Data</h3> <div class="chart-container svelte-js47dh"></div> <div class="custom-legend svelte-js47dh"><div class="legend-item svelte-js47dh"><div class="legend-dot hr-dot svelte-js47dh"></div> <span class="legend-label svelte-js47dh">Heart Rate</span> <span> </span></div> <div class="legend-item svelte-js47dh"><div class="legend-dot rmssd-dot svelte-js47dh"></div> <span class="legend-label svelte-js47dh">Balance</span> <span> </span></div> <div class="legend-item svelte-js47dh"><div class="legend-dot vibe-dot svelte-js47dh"></div> <span class="legend-label svelte-js47dh">Vibe Score</span> <span> </span></div></div></div> <div class="breathing-guide-section svelte-js47dh"><h3 class="mb-3 text-xl font-semibold svelte-js47dh">Breathing Guide</h3> <p class="mb-3 text-sm text-gray-500 svelte-js47dh">Follow the rhythm</p> <div class="breathing-guide-container svelte-js47dh"><div class="breathing-pulse-ring svelte-js47dh"></div> <div><div class="breathing-text svelte-js47dh"> </div> <div class="breathing-timer svelte-js47dh"> </div></div> <div class="breathing-ripple svelte-js47dh"></div></div></div> <div class="button-container svelte-js47dh"><button class="stop-button svelte-js47dh">Stop Session</button></div></div></div>'),Jt=k('<div class="error-message svelte-js47dh"> </div>'),Kt=k('<div class="modal-overlay svelte-js47dh"><div class="summary-modal svelte-js47dh"><h2 class="svelte-js47dh">Session Summary</h2> <div class="summary-stats svelte-js47dh"><div class="summary-stat svelte-js47dh"><span class="stat-label svelte-js47dh">Duration</span> <span class="stat-value svelte-js47dh"> </span></div> <div class="summary-stat svelte-js47dh"><span class="stat-label svelte-js47dh">Avg Heart Rate</span> <span class="stat-value svelte-js47dh"> </span></div> <div class="summary-stat svelte-js47dh"><span class="stat-label svelte-js47dh">Avg Balance (RMSSD)</span> <span class="stat-value svelte-js47dh"> </span></div> <div class="summary-stat svelte-js47dh"><span class="stat-label svelte-js47dh">Vibe Score</span> <span class="stat-value svelte-js47dh"> </span></div></div> <!> <div class="summary-actions svelte-js47dh"><button class="save-button svelte-js47dh"><!></button> <button class="discard-button svelte-js47dh">Discard Session</button></div></div></div>'),Qt=k('<div class="hrv-session-container svelte-js47dh"><h1 class="svelte-js47dh">HRV Session</h1> <!> <!></div> <!>',1);function ps(n,e){jt(e,!1);const[r,m]=Bt(),l=()=>ue(ge,"$hrvData",r),u=()=>ue(N,"$sessionTimer",r),_=()=>ue(Pt,"$authStore",r),y=()=>ue(I,"$bleConnectionStatus",r);let D=C(),p=null,P=C("inhale"),U=C(0),R=null,L=C(!1),me=C(!1),S=C(null),$=C(null),q=C(null),W=C(!1),ae=C(!1),A=C({hr:"-",rmssd:"-",vibe:"-"});function Me(){if(!s(D))return console.error("Chart element not found"),null;console.log("Initializing chart with element:",s(D));const c={width:s(D).clientWidth,height:240,padding:[20,0,0,0],cursor:{show:!0,points:{show:!1},drag:{setScale:!1},focus:{prox:30},dataIdx:(h,d,v)=>{if(v!==null){const i=h.data;f(A,{hr:i[1][v]!==null?i[1][v].toFixed(0)+" bpm":"-",rmssd:i[2][v]!==null?i[2][v].toFixed(1)+" ms":"-",vibe:i[3][v]!==null?i[3][v].toFixed(0):"-"})}return v}},legend:{show:!1},series:[{},{scale:"hr",label:"Heart Rate",value:(h,d)=>d==null?"-":d.toFixed(0)+" bpm",stroke:"rgba(229, 57, 53, 0.8)",width:2,points:{show:!1},spanGaps:!0},{scale:"rmssd",label:"Balance",value:(h,d)=>d==null?"-":d.toFixed(1)+" ms",stroke:"rgba(77, 68, 179, 0.8)",width:2,points:{show:!1},spanGaps:!0},{scale:"vibe",label:"Vibe Score",value:(h,d)=>d==null?"-":d.toFixed(0),stroke:"rgba(191, 70, 154, 0.8)",width:2,points:{show:!1},spanGaps:!0}],scales:{x:{time:!0,auto:!1,range:(h,d,v)=>{const i=Date.now()/1e3;return[i-120,i]}},hr:{auto:!0,range:[40,180]},rmssd:{auto:!0,range:[0,100]},vibe:{auto:!0,range:[0,100]}},axes:[]};try{console.log("Creating uPlot instance with options:",c),p=new kt(c,[[],[],[],[]],s(D)),console.log("Chart created successfully:",p),p&&p.hooks&&p.hooks.setData&&p.hooks.setData.push(()=>{var h,d,v;if(p){const i=p.data[0].length-1;i>=0&&f(A,{hr:p.data[1][i]!==null?(((h=p.data[1][i])==null?void 0:h.toString())||"-")+" bpm":"-",rmssd:p.data[2][i]!==null?(((d=p.data[2][i])==null?void 0:d.toString())||"-")+" ms":"-",vibe:p.data[3][i]!==null&&((v=p.data[3][i])==null?void 0:v.toString())||"-"})}})}catch(h){return console.error("Error creating chart:",h),null}const g=new ResizeObserver(h=>{p&&h[0]&&p.setSize({width:h[0].contentRect.width,height:240})});return g.observe(s(D)),()=>{p&&(p.destroy(),p=null),g.disconnect()}}function Ye(){if(!p)if(console.warn("Cannot update chart: chart instance is null"),s(D)&&!p){if(console.log("Attempting to reinitialize chart..."),Me(),!p)return}else return;const c=l().chartData;if(c.length===0){console.log("No chart data available yet");return}console.log("Updating chart with data points:",c.length);const g=c.map(i=>new Date(i.timestamp).getTime()/1e3),h=c.map(i=>i.hr),d=c.map(i=>i.rmssd),v=c.map(i=>i.vibe);try{p.setData([g,h,d,v]),console.log("Chart updated successfully")}catch(i){console.error("Error updating chart:",i)}}function Ze(){let d="inhale",v=0,i=Date.now();R=setInterval(()=>{const H=Date.now(),w=H-i;i=H,d==="inhale"?(v+=w/4e3*100,v>=100&&(v=0,d="exhale")):(v+=w/6e3*100,v>=100&&(v=0,d="inhale")),f(P,d),f(U,v)},16)}function ke(){R&&(clearInterval(R),R=null)}async function et(){var c;if(f($,null),!Ie()){f($,"Bluetooth is not supported on this device. Please use a device with Bluetooth support.");return}try{const g=await Lt();g.success?(u().isRunning||Xe(),Ze(),He(),f(L,!0)):f($,((c=g.error)==null?void 0:c.message)||"Failed to connect to device.")}catch(g){console.error("Error starting session:",g),f($,g instanceof Error?g.message:"An unknown error occurred.")}}async function tt(){if(!(!_().user||!s(S))){f(W,!0),f(q,null);try{const c={timestamp:new Date().toISOString(),start:s(S).startTime,end:s(S).endTime,duration_seconds:s(S).durationSeconds,avg_hr:s(S).avgHR,avg_rmssd:s(S).avgRMSSD,vibe_score:s(S).avgVibe,chart_data:s(S).chartData,rr_intervals:s(S).rrIntervals};if((await Mt(_().user,c)).success)if(f(ae,!0),await Vt(_().user)){const d=Ke.showRandomTool();d&&await Ke.logToolInteraction(_().user,d.id,"shown")}else setTimeout(()=>{Ce("/history")},2e3);else f(q,"Failed to save HRV session. Please try again.")}catch(c){console.error("Error saving HRV session:",c),f(q,"An unexpected error occurred. Please try again.")}finally{f(W,!1)}}}function st(){Ve(),ke(),f(S,Ot()),f(me,!0)}function at(){He(),f(L,!1),f(me,!1),f(S,null),Be(),Ce("/home")}function fe(c){const g=Math.floor(c/60),h=c%60;return`${g}:${h.toString().padStart(2,"0")}`}It(()=>{const c=Me();return()=>{c==null||c(),ke(),Be()}}),Ht(()=>{R&&clearInterval(R),Be()}),yt(()=>l(),()=>{l().chartData.length>0&&(console.log("HRV data updated, chart data points:",l().chartData.length),Ye())}),Dt(),Ct();var Ue=Qt(),_e=Et(Ue),Le=o(t(_e),2);{var rt=c=>{var g=qt(),h=o(t(g),2);{var d=w=>{var T=zt(),J=t(T,!0);a(T),de(()=>b(J,s($))),B(w,T)};M(h,w=>{s($)&&w(d)})}var v=o(h,2),i=o(v,2);{var H=w=>{var T=Nt();B(w,T)};M(i,w=>{Ie()||w(H)})}a(g),ve("click",v,et),B(c,g)},nt=c=>{var g=Wt(),h=t(g),d=t(h),v=t(d);let i;var H=o(v,2),w=t(H,!0);a(H),a(d);var T=o(d,2),J=t(T,!0);a(T),a(h);var F=o(h,2),G=t(F),K=t(G),Q=o(t(K),2),re=t(Q);Re(),a(Q),a(K);var X=o(K,2),Y=o(t(X),2),be=t(Y);Re(),a(Y),a(X);var Z=o(X,2),V=o(t(Z),2),Se=t(V,!0);a(V),a(Z),a(G);var ee=o(G,2),ne=t(ee),oe=t(ne,!0);a(ne),a(ee);var j=o(ee,2),E=o(t(j),2);xt(E,De=>f(D,De),()=>s(D));var O=o(E,2),te=t(O),x=o(t(te),4);let z;var ct=t(x,!0);a(x),a(te);var we=o(te,2),ie=o(t(we),4);let $e;var dt=t(ie,!0);a(ie),a(we);var Fe=o(we,2),le=o(t(Fe),4);let Ge;var vt=t(le,!0);a(le),a(Fe),a(O),a(j);var je=o(j,2),Oe=o(t(je),4),ce=o(t(Oe),2);let ze;var ye=t(ce),ut=t(ye,!0);a(ye);var Ne=o(ye,2),ht=t(Ne,!0);a(Ne),a(ce),Re(2),a(Oe),a(je);var qe=o(je,2),pt=t(qe);a(qe),a(F),a(g),de((De,gt,mt,ft,_t,bt,St,wt)=>{i=se(v,1,"status-indicator svelte-js47dh",null,i,De),b(w,y().connected?`Connected to ${y().deviceName}`:"Disconnected"),b(J,gt),b(re,`${l().heartRate??""} `),b(be,`${mt??""} `),b(Se,l().vibeScore),b(oe,ft),z=se(x,1,"legend-value svelte-js47dh",null,z,_t),b(ct,s(A).hr),$e=se(ie,1,"legend-value svelte-js47dh",null,$e,bt),b(dt,s(A).rmssd),Ge=se(le,1,"legend-value svelte-js47dh",null,Ge,St),b(vt,s(A).vibe),ze=se(ce,1,"breathing-circle svelte-js47dh",null,ze,wt),Ut(ce,`transform: scale(${s(P)==="inhale"?.4+s(U)/100*.6:1-s(U)/100*.8})`),b(ut,s(P)==="inhale"?"In":"Out"),b(ht,s(P)==="inhale"?"4s":"6s")},[()=>({connected:y().connected}),()=>fe(u().elapsedSeconds),()=>l().rmssd.toFixed(1),()=>fe(u().elapsedSeconds),()=>({"has-value":s(A).hr!=="-"}),()=>({"has-value":s(A).rmssd!=="-"}),()=>({"has-value":s(A).vibe!=="-"}),()=>({inhale:s(P)==="inhale",exhale:s(P)==="exhale"})],Je),Te(1,x,()=>xe,()=>({duration:150})),Te(1,ie,()=>xe,()=>({duration:150})),Te(1,le,()=>xe,()=>({duration:150})),ve("click",pt,st),B(c,g)};M(Le,c=>{s(L)?c(nt,!1):c(rt)})}var ot=o(Le,2);{var it=c=>{var g=Kt(),h=t(g),d=o(t(h),2),v=t(d),i=o(t(v),2),H=t(i,!0);a(i),a(v);var w=o(v,2),T=o(t(w),2),J=t(T);a(T),a(w);var F=o(w,2),G=o(t(F),2),K=t(G);a(G),a(F);var Q=o(F,2),re=o(t(Q),2),X=t(re,!0);a(re),a(Q),a(d);var Y=o(d,2);{var be=j=>{var E=Jt(),O=t(E,!0);a(E),de(()=>b(O,s(q))),B(j,E)};M(Y,j=>{s(q)&&j(be)})}var Z=o(Y,2),V=t(Z),Se=t(V);{var ee=j=>{var E=Ee("Saving...");B(j,E)},ne=(j,E)=>{{var O=x=>{var z=Ee("Saved!");B(x,z)},te=x=>{var z=Ee("Save Session");B(x,z)};M(j,x=>{s(ae)?x(O):x(te,!1)},E)}};M(Se,j=>{s(W)?j(ee):j(ne,!1)})}a(V);var oe=o(V,2);a(Z),a(h),a(g),de((j,E)=>{b(H,j),b(J,`${s(S).avgHR??""} bpm`),b(K,`${E??""} ms`),b(X,s(S).avgVibe),V.disabled=s(W)||s(ae),oe.disabled=s(W)||s(ae)},[()=>fe(s(S).durationSeconds),()=>s(S).avgRMSSD.toFixed(1)],Je),ve("click",V,tt),ve("click",oe,at),B(c,g)};M(ot,c=>{s(me)&&s(S)&&c(it)})}a(_e);var lt=o(_e,2);At(lt,{onClose:()=>Ce("/history")}),B(n,Ue),Rt(),m()}export{ps as component};
